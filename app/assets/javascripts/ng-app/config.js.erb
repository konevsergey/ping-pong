(function() {
  'use strict';

  angular.module('app', [
    'ui.router',
    'LocalStorageModule',
    'ngResource',
    'ncy-angular-breadcrumb',
    'rails',
    'ui-notification',
    'angularSpinner',
    'satellizer',
    'ngAnimate',
    'checklist-model'
  ]);

  angular.module('app').config(
    function($locationProvider, $httpProvider, NotificationProvider, $authProvider) {
      $locationProvider.html5Mode(true);

      NotificationProvider.setOptions({
        startTop: 55
      });
      // GitHub
      $authProvider.github({
        url: '/auth/github/callback',
        clientId: <%= "'#{ENV['GITHUB_KEY']}'" %>,
        redirectUri: window.location.origin + '/',
        scope: ['user:name, user:email'],
      });

      // Facebook
      $authProvider.facebook({
        url: '/auth/facebook/callback',
        clientId: <%= "'#{ENV['FACEBOOK_KEY']}'" %>,
        redirectUri: window.location.origin + '/',
        scope: 'email'
      });

      // Vkontakte
      $authProvider.oauth2({
        name: 'vkontakte',
        url: '/auth/vkontakte/callback',
        authorizationEndpoint: 'https://oauth.vk.com/authorize',
        clientId: <%= "'#{ENV['VKONTAKTE_KEY']}'" %>,
        redirectUri: window.location.origin + '/',
        scope: 'email',
        display: 'popup',
        responseType: 'code',
        requiredUrlParams: ['response_type', 'client_id', 'redirect_uri', 'display', 'scope'],
        scopeDelimiter: ',',
      });


      $httpProvider.interceptors.push('ErrorHandlerInterceptor');

    });


  run.$inject = ['$rootScope', 'Notification', '$state', '$auth', 'User', '$document', '$window'];
  function run($rootScope, Notification, $state, $auth, User, $document, $window) {

    $rootScope.setUser = setUser;
    setUser();

    $rootScope.$on('responseError', function(event, responce) {
      console.log(responce);
      Notification.error(responce.statusText);
    });

    $rootScope.$on('error', function(event, message) {
      Notification.error(message);
    });

    $rootScope.$on('auth_error', function(event, message) {
      $state.go('login')
      Notification.error(message);
    });

    $rootScope.$on('auth', function(event) {
      setUser();
    });

    $rootScope.$on('logout', function(event, message) {
      $rootScope.current_user = {}
    });

    $rootScope.$on('$stateChangeSuccess', function(event){
      //setUser();
    })

    function setUser(new_user) {
      if (new_user) {
        $rootScope.current_user = new_user
      } else {
        if ($auth.isAuthenticated()) {
          User.get($auth.getPayload()['user_id']).then(function(response){
            $rootScope.current_user = response;
          })
        } else {
          $rootScope.current_user = {}
        }
      };
    }

    // angular.element($document).ready(function(){
    //   var target = angular.element('#navbar-container');
    //   target.css('z-index', '0.1');
    //   angular.element($document).scroll(function(e){
    //       if ($window.scrollY >= 75){
    //         target.css('opacity', '0.8');
    //       }
    //       else  target.css('opacity', '1');
    //   });
    //   target.hover(function(e) {
    //     target.css('opacity', '1');
    //   }, function(e) {
    //     if ($window.scrollY >= 75){
    //       target.css('opacity', '0.8');
    //     }
    //     else  target.css('opacity', '1');
    //   })
    // })
  }
  angular.module('app').run(run);
})();
